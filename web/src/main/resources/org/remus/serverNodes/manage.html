<html>
<head>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.11.min.js"></script>
<link href="jquery-ui-1.8.11.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="jquery.treeview.css" type="text/css" />

<script src="jquery.jsonviewer.js" type="text/javascript"></script> 
<script src="jquery.treeview.js" type="text/javascript"></script> 
<script src="jquery.popupwindow.js" type="text/javascript"></script> 

<style type="text/css"> 
	
/* Vertical Tabs

.ui-tabs-vertical { width: 55em; }
.ui-tabs-vertical .ui-tabs-nav { padding: .2em .1em .2em .2em; float: left; width: 12em; }
.ui-tabs-vertical .ui-tabs-nav li { clear: left; width: 100%; border-bottom-width: 1px !important; border-right-width: 0 !important; margin: 0 -1px .2em 0; }
.ui-tabs-vertical .ui-tabs-nav li a { display:block; }
.ui-tabs-vertical .ui-tabs-nav li.ui-tabs-selected { padding-bottom: 0; padding-right: .1em; border-right-width: 1px; border-right-width: 1px; }
.ui-tabs-vertical .ui-tabs-panel { padding: 1em; float: right; width: 40em;}
----------------------------------*/
.ui-widget { font-size: 0.75em; }
</style> 
</head>
<body>
<script type="text/javascript">


function makeErrorUL( dict ) {
	var ul = $("<ul>");	
	for ( e in dict ) {
		if ( dict[e] == null || typeof dict[e] == "string" ) {
			var a = e + " " + dict[e];
			ul.append( $("<li>").append( $("<span class='file'>").append(a) ) );
		} else {
			var li = $("<li class='closed'>").append( $("<span class='folder'>").append(e) );
			li.append( makeErrorUL( dict[e] ) );
			ul.append( li );
		}
	}
	return ul;
}


var errorView = function( pipeline ) {

	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Error View"; }, 
		getDiv : function() {
			var ul=$("<div>");
			var i;
			var path = "/" + pipeline + "/@error/";			
			$.get( path , function(data) {
				var paths = {};
				var lines = data.split("\n");
				for (i = 0; i < lines.length; i++) {
					var d = $.parseJSON( lines[i] );
					for ( e in d ) {
						paths[ e.replace(":", "/") ] = d[e];
					}
				}
				var dirSet = dirDecomp( paths );
				ul.append( makeErrorUL( dirSet ).attr('class', 'filetree' ).treeview() );
				
			});
			
			return ul;
		}
	};
};

var statusScan = function( pipeline ) {
	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Status Scan"; }, 
		getDiv : function() {
			var base = $("<div>");
			var text = $("<textarea id='submitScanText' rows='5' cols='50'>");
			text.append( "function(key,val) { remus.emit( key,val ); }" );
			var submit = $("<button>");
			var output = $("<div>");
			submit.append("Scan");
			submit.bind( "click", function() {
				output.empty();
				$.post( "/" + pipeline + "/@status", text.val(), function(data) {
					var lines = data.split("\n");
					for ( a in lines) {
						var valData = JSON.parse(lines[a]);		
						output.append( $("<div>").jsonviewer( { "json_name" : "status", "json_data" : valData } )  );				
					}
				});
			});
			base.append( $("<div>").append( "Scan Submit" ) );
			base.append( text );
			base.append( submit );
			base.append( output );
			return base;
		} 
	};	
};

var submissionEditor = function( pipeline ) {
	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Submission Editor"; }, 
		getDiv : function() {
			var base = $("<div>");			
			base.append( "Submission");
			return base;
		} 
	};	
};


var instanceSelector = function(pipeline, callback) {
	return function () {
		var viewBase = $("<div>");
		var ul=$("<ul>");
		viewBase.append( htmlHideBar( "Instances", ul ) );
		var instBase = $("<div>");
		$.getJSON( "/" + pipeline + "/@submit", function(data) {
			var a;
			for (a in data ) {
				var li = $("<li>");
				var anchor = $("<a href='#" + pipeline + "-tab-" + a + "'>").append( $("<span>").append( a ) );
				anchor.bind( 'click', data[a]["_instance"], function(event) {
					instBase.empty();
					instBase.append( callback( event.data ) );
				});
				li.append( anchor );
				li.append( data[a]["_instance"] ); 
				ul.append( li ); 
			}
		});
		viewBase.append( instBase );
		return viewBase;
	}
}


var appletSelector = function( pipeline, instance, callback ) {
	var data;
	var selectStr = "function(key,val) { if (key.indexOf('" + instance + "')==0) {remus.emit( key, { '_name' : key.split(':')[1], '_instance' : val['_instance'] } );} }";	
	$.ajax( {
		url:"/" + pipeline + "/@status",
	    type: 'POST',
	    async: false,
	    cache: false,
	    data: selectStr,
	    timeout: 30000,
	    error: function(){
	        return true;
	    },
	    success: function(msg){ 
			data=msg;
		}
	}
	);

	var viewBase = $("<div>");	
	var dataBase = $("<div>");
	var ul=$("<ul>");
	viewBase.append( ul );
	viewBase.append(dataBase);

	var lines = data.split("\n");
	for (var curLine in lines ) {
		var li = $("<li>");
		var d = $.parseJSON( lines[curLine] );
		for ( var a in d ) {
			var appletName = d[a]["_name"];
			var anchor = $("<a href='#'>").append( $("<span>").append( appletName ) );
			anchor.bind( 'click', appletName, function(event) {
					dataBase.empty();
					dataBase.append( callback( event.data ) );
				}
			);
			li.append( anchor );
			li.append( d[a]["_instance"] ); 
			ul.append( li ); 	
		}	
	}	
	return viewBase;
};



var htmlHideBar = function(title, html) {
	 var container = $('<div/>');
     $(container).addClass('ui-widget').css({'padding': "4px", 'padding-left': "12px" });
     var header = $('<div/>');
     $(header).appendTo(container);
     $(header).addClass('ui-widget-header ui-corner-all')
         .css({ 'cursor': 'hand', //'float': 'left',
             'text-align': 'left', 'white-space': 'nowrap',
             'overflow': 'hidden'
         });
     $(header).click(function(event) {
	     $(container).children('.ui-widget-content').toggleClass('ui-helper-hidden');
         return false;
     });

     $(header).text( title );
    var content = $('<div/>');
    $(content).appendTo(container);
    $(content).addClass('ui-widget-content ui-corner-all')
    .css({ 'overflow': 'hidden', 'white-space': 'nowrap' });
    $(content).append( html );
	return container;
}


var stackViewer = function( pipeline, instance, applet ) {
	var base = $("<div>").css('position', 'relative');

	var spinner = $("<img src='ajax-loader.gif'/>");
	base.append( spinner );
	var ul=$("<select size='20' style='width:300px'>");
	ul.css( 'width', '25%');
	ul.css( 'position', 'absolute');
	base.append( ul );		
	
	var rightDiv = $("<div>");
	rightDiv.css( 'width', '70%');
	rightDiv.css( 'position', 'absolute');
	rightDiv.css('right', '0');
	base.append(rightDiv); 

	var attachDiv = $("<div>");						
	rightDiv.append( attachDiv );
	
	var valueDiv = $("<div>");
	rightDiv.append( valueDiv );
	
	
	var i;
	var path = "/" + pipeline + "/" + instance + "/" + applet;
	$.get( path , function(data) {
		spinner.remove();
		var lines = data.split("\n");
		for (i = 0; i < lines.length; i++) {
			if ( lines[i].length > 0 ) {
				var keyStr = $.parseJSON( lines[i] );
				var opt = $("<option>").append( keyStr );
				ul.append( opt );
			}
		}
	});
	ul.bind( 'change', function() {
		valueDiv.empty();
		//BUG: need to do URL encode
		$.get( "/" + pipeline + "/" + instance + "/" + applet + "/" + ul.val(),
			function(data) {
				var lines = data.split("\n");
				for ( a in lines ) {
					if ( lines[a].length > 0 ) {
						var valData = JSON.parse(lines[a]);		
						valueDiv.append( $("<div>").jsonviewer( { "json_name" : ul.val(), "json_data" : valData[ul.val()] } )  );
					}
				}
			}
		);
		var attachListURL = "/" + pipeline + "/" + instance + "/@attach/" + applet + "/" + ul.val();
		$.get( attachListURL,
			function(data) {
				attachDiv.empty();
				var lines = data.split("\n");
				var htmlDiv = $("<div>");
				for ( a in lines ) {	
					var link = $("<a>");
					var name = $.parseJSON( lines[a] );
					link.append( name );
					link.attr( "href", attachListURL + "/" + name );	
					link.attr( "target", "_blank" );	
					htmlDiv.append( link );
					htmlDiv.append( "<br/>" );
				}
				attachDiv.append( htmlHideBar( "Attachments", htmlDiv ) );
			}
		);
	});					
	return base;
}


var instanceViewer = function(pipeline) {
	return {
		getTitle : function() { return "Instance Viewer"; }, 
		getDiv : instanceSelector( pipeline, function(instance) {
			return function(applet) {
				return appletSelector( pipeline, instance, function( applet ) {					
					var base = $("<div>").css('position', 'relative');

					var spinner = $("<img src='ajax-loader.gif'/>");
					base.append( spinner );
					var ul=$("<select size='20' style='width:300px'>");
					ul.css( 'width', '25%');
					ul.css( 'position', 'absolute');
					base.append( ul );

					
					
					var rightDiv = $("<div>");
					rightDiv.css( 'width', '70%');
					rightDiv.css( 'position', 'absolute');
					rightDiv.css('right', '0');
					base.append(rightDiv); 

					var attachDiv = $("<div>");						
					rightDiv.append( attachDiv );
					
					var valueDiv = $("<div>");
					rightDiv.append( valueDiv );
					
					
					var i;
					var path = "/" + pipeline + "/" + instance + "/" + applet;
					$.get( path , function(data) {
						spinner.remove();
						var lines = data.split("\n");
						for (i = 0; i < lines.length; i++) {
							if ( lines[i].length > 0 ) {
								var keyStr = $.parseJSON( lines[i] );
								var opt = $("<option>").append( keyStr );
								ul.append( opt );
							}
						}
					});
					ul.bind( 'change', function() {
						valueDiv.empty();
						//BUG: need to do URL encode
						$.get( "/" + pipeline + "/" + instance + "/" + applet + "/" + ul.val(),
							function(data) {
								var lines = data.split("\n");
								for ( a in lines ) {
									if ( lines[a].length > 0 ) {
										var valData = JSON.parse(lines[a]);		
										valueDiv.append( $("<div>").jsonviewer( { "json_name" : ul.val(), "json_data" : valData[ul.val()] } )  );
									}
								}
							}
						);
						var attachListURL = "/" + pipeline + "/" + instance + "/@attach/" + applet + "/" + ul.val();
						$.get( attachListURL,
							function(data) {
								attachDiv.empty();
								var lines = data.split("\n");
								var htmlDiv = $("<div>");
								for ( a in lines ) {	
									var link = $("<a>");
									var name = $.parseJSON( lines[a] );
									link.append( name );
									link.attr( "href", attachListURL + "/" + name );	
									link.attr( "target", "_blank" );	
									htmlDiv.append( link );
									htmlDiv.append( "<br/>" );
								}
								attachDiv.append( htmlHideBar( "Attachments", htmlDiv ) );
							}
						);
					});					
					return base;
				});
				};
		})
	}
};




String.prototype.count=function(s1) { 
    return (this.length - this.replace(new RegExp(s1,"g"), '').length) / s1.length;
}

function dirDecomp( array ) {
	var base = {}	
	for ( i in array ) {
		var tmp = i.split("/");
		base[ tmp[0] ] = {};
	}
	for ( dir in base ) {
		var cur = {};
		var count = 0;
		for ( i in array ) {
			if ( i.indexOf( dir ) == 0 ) {
				if ( i.count( "/" ) > 0 ) {
					cur[ i.replace( dir + "/", "" ) ] = array[i];
					count++;
				}
			}
		}
		if ( count > 0 ) {
			base[dir] = dirDecomp( cur );
		} else {
			base[dir] = array[dir];
		}
	}
	return base
}

function makeStackViewUL( dict, pipeline ) {
	var ul = $("<ul>");	
	for ( e in dict ) {
		if ( dict[e] == null || typeof dict[e] == "string" ) {
			//var a = $("<a href='#'>").bind( 'click', {func : callback, sel : e}, function(msg) { 
			//	msg.data.func(msg.data.sel); 
			//} );
			var tmp = e.split(':');
			var a;
			if (tmp.length == 3) {
				a = $("<a target='_blank'>").attr( 'href', "stackViewer.html?pipeline=" + pipeline + "&instance=" + tmp[0] + "&applet=" + tmp[1] + ":" + tmp[2] );
			} else {
				a = $("<a target='_blank'>").attr( 'href', "stackViewer.html?pipeline=" + pipeline + "&instance=" + tmp[0] + "&applet=" + tmp[1] );
			}
			a.popupwindow();
			a.append(e);
			ul.append( $("<li>").append( $("<span class='file'>").append(a) ) );
		} else {
			var li = $("<li class='closed'>").append( $("<span class='folder'>").append(e) );
			li.append( makeStackViewUL( dict[e], pipeline ) );
			ul.append( li );
		}
	}
	return ul;
}


var instanceTree = function( pipeline ) {
	
	var selectDiv = $("<div>");	

	var setDiv = function( input ) {
		selectDiv.empty();
		var tmp = input.split(':');
		selectDiv.append( stackViewer( pipeline, tmp[0], tmp[1] ) );
	};
	
	return {
		getTitle : function() { return "Instance Tree"; }, 
		getDiv : function() {
			var div = $("<div>");
			var data = "";
			var selectStr = "function(key,val) { remus.emit( key, val._group) }";	
			$.ajax( {
				url:"/" + pipeline + "/@status",
			    type: 'POST',
			    async: false,
			    cache: false,
			    data: selectStr,
			    timeout: 30000,
			    error: function(){
			        return true;
			    },
			    success: function(msg){ 
					data=msg;
				}
			}
			);

			var lines = data.split("\n");
			var dirList = {}
			for ( i in lines ) {
				var d = $.parseJSON( lines[i] );
				for ( e in d ) {
					dirList[ d[e] + "/" + e ] = e;
				}
			}
			var dirSet = dirDecomp( dirList );			
			div.append( makeStackViewUL( dirSet, pipeline ).attr('class', 'filetree' ).treeview() );
			div.append( selectDiv );
			return div;
		}
	};	
};


var toolSelector = function( pipeline ) {
	var tools = [ instanceTree(pipeline), submissionEditor( pipeline ), statusScan( pipeline ), errorView(pipeline) ];

	return {
		getDiv : function() {
			var div = $("<div>");
			var view = $("<div>");
			var i;
			for ( i in tools ) {
				if ( i != 0 ) {
					div.append( " | " );
				}
				var a = $("<a>");
				a.attr('href', '#');
				a.append( tools[i].getTitle() );
				a.bind( 'click', i, function(event) {
					view.empty();
					view.append( tools[ event.data ].getDiv() );
				});
				div.append( a );
			}
			view.append( tools[ 0 ].getDiv() );			
			div.append( view );
			return div;
		}
	};
}

var pipelineSelector = function() {
	return {
		getDiv : function(  ) {
			var div = $("<div>");
			var child = $("<div>");
			var d=$("<select>");
	
			$.ajax( {
				url:"/@pipeline",
		    	type: 'GET',
		    	async: false,
		    	cache: false,
		    	timeout: 30000,
		    	dataType: 'json',
		    	error: function(){
		    	    return true;
		    	},
		    	success: function(data){ 
			    	var a;
		    		for (a in data ) {
		    			var item = $("<option>");
		    			item.attr( 'value', a );//.removeClass('ui-corner-top').addClass('ui-corner-left');		
		    			item.append( a );	
		    			d.append( item );
		    		}		
		    	}
			});			
			div.append( d );
			div.append( child );
			iViewer = new toolSelector( d.val() );
			child.append( iViewer.getDiv() );
			d.change( function() {
				child.empty();
				var pipeline = d.val();
				iViewer = toolSelector( d.val() );
				child.append( iViewer.getDiv() );
			});
			return div;
		}
	};	
};

var statusClock = function(div) {
	$.get( "/@status", dataType="json", function(msg) {
		var data = $.parseJSON( msg );
		$(div).empty();
		$(div).append( "Work Pending:" + data[ '_workBufferSize' ] );
	});
};	

var statusWatcher = function(div) {
	var inter = setInterval( "statusClock(" + div.attr('id') + ")", 10000 );
};


$(document).ready( function() {
	//statusWatcher( $("#statusBase") );
	var pipelines = pipelineSelector();
	$("#controlBase").append(  pipelines.getDiv() );
});

</script>
<div id="statusBase"></div>
<div id="controlBase"></div>

</body>
</html>