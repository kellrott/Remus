#!/bin/bash
#$ -cwd
#$ -S /bin/bash

binpath=`dirname $0`
basepath=`dirname $binpath`
HOST=`hostname`

if [ ! -e `which java` ]; then
	export PATH=$PATH:/usr/java/latest/bin/
fi

if [ -e ${basepath}/conf/${HOST}.yaml ]; then
    confFile=${basepath}/conf/${HOST}.yaml
fi

procName="remus_"`hostname`

mode="start"
backGround="false"
while [ $# -gt 0 ] ; do
	case $1 in
		-d) backGround="true"; shift 1;;
		-n) procName=$2; shift 2;;
		-stop) mode="stop"; shift 1;;
		-status) mode="status"; shift 1;;
		*) confFile=$1; shift 1;;
	esac
done

if [ "x$JOB_ID" == "x" ]; then
    JOB_ID="localhost"
fi

export JAVA_OPTS=-Xmx3G

VARPATH=${basepath}/var
PID_FILE=$VARPATH/${procName}.pid

case $mode in
stop)
	if [ -e $PID_FILE ]; then
		PID=`cat $PID_FILE`
		kill $PID
		rm -f $PID_FILE
	fi
;;
status)
	if [ -e $PID_FILE ]; then
		ps -p `cat $PID_FILE` > /dev/null
		if [ $? == "0" ]; then
			echo $procName "RUNNING"
		else
			echo $procName "DEAD"
		fi
	else
		echo $procName "NOT_FOUND"
	fi
;;
start)
	if [ $backGround == "true" ]; then
		setsid java -Dorg.remus.logName=remusWorker_${JOB_ID} ${JAVA_OPTS} -Djava.ext.dirs=${basepath}/lib org.remus.Boot ${confFile} > /dev/null < /dev/null &
		echo $! > $PID_FILE
	else
		java -Dorg.remus.logName=remusWorker_${JOB_ID} ${JAVA_OPTS} -Djava.ext.dirs=${basepath}/lib org.remus.Boot ${confFile}
	fi
;;
esac
