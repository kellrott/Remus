<html>
<head>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.11.min.js"></script>
<link href="jquery-ui-1.8.11.css" rel="stylesheet" type="text/css"/>

<style type="text/css"> 
	
/* Vertical Tabs
----------------------------------*/
.ui-tabs-vertical { width: 55em; }
.ui-tabs-vertical .ui-tabs-nav { padding: .2em .1em .2em .2em; float: left; width: 12em; }
.ui-tabs-vertical .ui-tabs-nav li { clear: left; width: 100%; border-bottom-width: 1px !important; border-right-width: 0 !important; margin: 0 -1px .2em 0; }
.ui-tabs-vertical .ui-tabs-nav li a { display:block; }
.ui-tabs-vertical .ui-tabs-nav li.ui-tabs-selected { padding-bottom: 0; padding-right: .1em; border-right-width: 1px; border-right-width: 1px; }
.ui-tabs-vertical .ui-tabs-panel { padding: 1em; float: right; width: 40em;}
	</style> 
</head>
<body>
<script type="text/javascript">

var errorView = function( pipeline ) {

	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Error View"; }, 
		getDiv : instanceSelector(pipeline, function(instance) {
			return appletSelector(pipeline, instance, function( applet ) {
				
				var ul=$("<select size=10>");
				var i;
				var path = "/" + pipeline + "/" + instance + "/@error/" + applet;
				$.get( path , function(data) {
					var lines = data.split("\n");
					for (i = 0; i < lines.length; i++) {
						if ( lines[i].length > 0 ) {
							ul.append( $("<option>").append( lines[i] ) );
						}
					}
				});
				return ul;

				
			})
		})

	};
};

var statusScan = function( pipeline ) {
	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Status Scan"; }, 
		getDiv : function() {
			var base = $("<div>");
			var text = $("<textarea id='submitScanText' rows='5' cols='50'>");
			text.append( "function(key,val) { remus.emit( key,val ); }" );
			var submit = $("<button>");
			var output = $("<div>");
			submit.append("Scan");
			submit.bind( "click", function() {
				output.empty();
				$.post( "/" + pipeline + "/@status", text.val(), function(data) {
					output.append( data );					
				});
			});
			base.append( $("<div>").append( "Scan Submit" ) );
			base.append( text );
			base.append( submit );
			base.append( output );
			return base;
		} 
	};	
};

var submissionEditor = function( pipeline ) {
	return {
		'pipeline' : pipeline,
		getTitle : function() { return "Submission Editor"; }, 
		getDiv : function() {
			var base = $("<div>");			
			base.append( "Submission");
			return base;
		} 
	};	
};


var instanceSelector = function(pipeline, callback) {
	return function () {
		var viewBase = $("<div>");
		var ul=$("<ul>");
		viewBase.append( ul );
		var instBase = $("<div>");
		$.getJSON( "/" + pipeline + "/@submit", function(data) {
			var a;
			for (a in data ) {
				var li = $("<li>");
				var anchor = $("<a href='#" + pipeline + "-tab-" + a + "'>").append( $("<span>").append( a ) );
				anchor.bind( 'click', a, function(event) {
					instBase.empty();
					instBase.append( callback( event.data ) );
				});
				li.append( anchor );
				li.append( data[a]["_instance"] ); 
				ul.append( li ); 
			}
		});
		viewBase.append( instBase );
		return viewBase;
	}
}


var appletSelector = function( pipeline, instance, callback ) {
	var data;
	$.ajax( {
		url:"/" + pipeline + "/@pipeline",
	    type: 'GET',
	    async: false,
	    cache: false,
	    timeout: 30000,
	    dataType: 'json',
	    error: function(){
	        return true;
	    },
	    success: function(msg){ 
			data=msg;
		}
	}
	);

	var viewBase = $("<div>");	
	var dataBase = $("<div>");
	var ul=$("<ul>");
	viewBase.append( ul );
	viewBase.append(dataBase);

	for (var a in data ) {
		var li = $("<li>");
		var appletName = a;
		var anchor = $("<a href='#'>").append( $("<span>").append( a ) );
		anchor.bind( 'click', appletName, function(event) {
				dataBase.empty();
				dataBase.append( callback( event.data ) );
			}
		);
		li.append( anchor );
		li.append( data[a]["_instance"] ); 
		ul.append( li ); 		
	}	
	return viewBase;
};


var instanceViewer = function(pipeline) {
	return {
		getTitle : function() { return "Instance Viewer"; }, 
		getDiv : instanceSelector( pipeline, function(instance) {
			return function(applet) {
				return appletSelector( pipeline, instance, function( applet ) {					
					var base = $("<div>").css('position', 'relative');
					var ul=$("<select size='20' style='width:300px'>");
					ul.css( 'width', '25%');
					ul.css( 'position', 'absolute');
					base.append( ul );
					var valueDiv = $("<div>");
					valueDiv.css( 'width', '70%');
					valueDiv.css( 'position', 'absolute');
					valueDiv.css('right', '0');
					base.append(valueDiv); 
					var i;
					var path = "/" + pipeline + "/" + instance + "/" + applet;
					$.get( path , function(data) {
						var lines = data.split("\n");
						for (i = 0; i < lines.length; i++) {
							if ( lines[i].length > 0 ) {
								var keyStr = $.parseJSON( lines[i] );
								var opt = $("<option>").append( keyStr );
								ul.append( opt );
							}
						}
					});
					ul.bind( 'change', function() {
						valueDiv.empty();
						//BUG: need to do URL encode
						$.get( "/" + pipeline + "/" + instance + "/" + applet + "/" + ul.val(),
							function(data) {
								valueDiv.append( data );								
							}
						);
					});					
					return base;
				});
				};
		})
	}
};



var toolSelector = function( pipeline ) {
	var tools = [ instanceViewer( pipeline ), submissionEditor( pipeline ), statusScan( pipeline ), errorView(pipeline) ];

	return {
		getDiv : function() {
			var div = $("<div>");
			var view = $("<div>");
			var i;
			for ( i in tools ) {
				if ( i != 0 ) {
					div.append( " | " );
				}
				var a = $("<a>");
				a.attr('href', '#');
				a.append( tools[i].getTitle() );
				a.bind( 'click', i, function(event) {
					view.empty();
					view.append( tools[ event.data ].getDiv() );
				});
				div.append( a );
			}
			view.append( tools[ 0 ].getDiv() );			
			div.append( view );
			return div;
		}
	};
}

var pipelineSelector = function() {
	return {
		getDiv : function(  ) {
			var div = $("<div>");
			var child = $("<div>");
			var d=$("<select>");
	
			$.ajax( {
				url:"/@pipeline",
		    	type: 'GET',
		    	async: false,
		    	cache: false,
		    	timeout: 30000,
		    	dataType: 'json',
		    	error: function(){
		    	    return true;
		    	},
		    	success: function(data){ 
			    	var a;
		    		for (a in data ) {
		    			var item = $("<option>");
		    			item.attr( 'value', a );//.removeClass('ui-corner-top').addClass('ui-corner-left');		
		    			item.append( a );	
		    			d.append( item );
		    		}		
		    	}
			});			
			div.append( d );
			div.append( child );
			iViewer = new toolSelector( d.val() );
			child.append( iViewer.getDiv() );
			d.change( function() {
				child.empty();
				var pipeline = d.val();
				iViewer = toolSelector( d.val() );
				child.append( iViewer.getDiv() );
			});
			return div;
		}
	};	
};


$(document).ready( function() {
	var pipelines = pipelineSelector();
	$("#controlBase").append(  pipelines.getDiv() );
});

</script>

<div id="controlBase"></div>

</body>
</html>