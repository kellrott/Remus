<html>
<head>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.11.min.js"></script>
<link href="jquery-ui-1.8.11.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="jquery.treeview.css" type="text/css" />

<script src="jquery.jsonviewer.js" type="text/javascript"></script> 

<style type="text/css"> 
	
/* Vertical Tabs

.ui-tabs-vertical { width: 55em; }
.ui-tabs-vertical .ui-tabs-nav { padding: .2em .1em .2em .2em; float: left; width: 12em; }
.ui-tabs-vertical .ui-tabs-nav li { clear: left; width: 100%; border-bottom-width: 1px !important; border-right-width: 0 !important; margin: 0 -1px .2em 0; }
.ui-tabs-vertical .ui-tabs-nav li a { display:block; }
.ui-tabs-vertical .ui-tabs-nav li.ui-tabs-selected { padding-bottom: 0; padding-right: .1em; border-right-width: 1px; border-right-width: 1px; }
.ui-tabs-vertical .ui-tabs-panel { padding: 1em; float: right; width: 40em;}
----------------------------------*/
.ui-widget { font-size: 0.75em; }
</style> 
</head>
<body>
<script type="text/javascript">



var htmlHideBar = function(title, html) {
	 var container = $('<div/>');
     $(container).addClass('ui-widget').css({'padding': "4px", 'padding-left': "12px" });
     var header = $('<div/>');
     $(header).appendTo(container);
     $(header).addClass('ui-widget-header ui-corner-all')
         .css({ 'cursor': 'hand', //'float': 'left',
             'text-align': 'left', 'white-space': 'nowrap',
             'overflow': 'hidden'
         });
     $(header).click(function(event) {
	     $(container).children('.ui-widget-content').toggleClass('ui-helper-hidden');
         return false;
     });

     $(header).text( title );
    var content = $('<div/>');
    $(content).appendTo(container);
    $(content).addClass('ui-widget-content ui-corner-all')
    .css({ 'overflow': 'hidden', 'white-space': 'nowrap' });
    $(content).append( html );
	return container;
}



var stackViewer = function( pipeline, instance, applet ) {
	var base = $("<div>").css('position', 'relative');

	var spinner = $("<img src='ajax-loader.gif'/>");
	base.append( spinner );
	var ul=$("<select size='20' style='width:300px'>");
	ul.css( 'width', '25%');
	ul.css( 'position', 'absolute');
	base.append( ul );		
	
	var rightDiv = $("<div>");
	rightDiv.css( 'width', '70%');
	rightDiv.css( 'position', 'absolute');
	rightDiv.css('right', '0');
	base.append(rightDiv); 

	var attachDiv = $("<div>");						
	rightDiv.append( attachDiv );
	
	var valueDiv = $("<div>");
	rightDiv.append( valueDiv );
	
	
	var i;
	var path = "/" + pipeline + "/" + instance + "/" + applet;
	$.get( path , function(data) {
		spinner.remove();
		var lines = data.split("\n");
		for (i = 0; i < lines.length; i++) {
			if ( lines[i].length > 0 ) {
				var keyStr = $.parseJSON( lines[i] );
				var opt = $("<option>").append( keyStr );
				ul.append( opt );
			}
		}
	});
	ul.bind( 'change', function() {
		valueDiv.empty();
		//BUG: need to do URL encode
		$.get( "/" + pipeline + "/" + instance + "/" + applet + "/" + ul.val(),
			function(data) {
				var lines = data.split("\n");
				for ( a in lines ) {
					if ( lines[a].length > 0 ) {
						var valData = JSON.parse(lines[a]);		
						valueDiv.append( $("<div>").jsonviewer( { "json_name" : ul.val(), "json_data" : valData[ul.val()] } )  );
					}
				}
			}
		);
		var attachListURL = "/" + pipeline + "/" + instance + "/@attach/" + applet + "/" + ul.val();
		$.get( attachListURL,
			function(data) {
				attachDiv.empty();
				var lines = data.split("\n");
				var htmlDiv = $("<div>");
				for ( a in lines ) {	
					var link = $("<a>");
					var name = $.parseJSON( lines[a] );
					link.append( name );
					link.attr( "href", attachListURL + "/" + name );	
					link.attr( "target", "_blank" );	
					htmlDiv.append( link );
					htmlDiv.append( "<br/>" );
				}
				attachDiv.append( htmlHideBar( "Attachments", htmlDiv ) );
			}
		);
	});					
	return base;
}


//Read a page's GET URL variables and return them as an associative array.
function getUrlVars()
{
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}


$(document).ready( function() {

	var input = getUrlVars();
	
	$("#viewerBase").append(  stackViewer( input.pipeline, input.instance, input.applet  ) );
});

</script>
<div id="viewerBase"></div>

</body>
</html>